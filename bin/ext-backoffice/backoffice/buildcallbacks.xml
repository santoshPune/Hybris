<?xml version="1.0"?>
<!--
  ~ [y] hybris Platform
  ~
  ~ Copyright (c) 2000-2016 SAP SE or an SAP affiliate company.
  ~ All rights reserved.
  ~
  ~ This software is the confidential and proprietary information of SAP
  ~ ("Confidential Information"). You shall not disclose such Confidential
  ~ Information and shall use it only in accordance with the terms of the
  ~ license agreement you entered into with SAP.
  -->

<project name="backoffice_buildcallbacks">

    <property name="webFragmentsSrcDir" value="${ext.backoffice.path}/web/webroot/WEB-INF/web-fragments"/>
    <property name="backofficeLibDir" value="${ext.backoffice.path}/web/webroot/WEB-INF/lib"/>
    <property name="backofficeFragmentPattern" value="webfragment*_"/>
    <property name="backofficeCoreFragmentPrefix" value="webfragmentCore_"/>

    <macrodef name="backoffice_after_clean">
        <sequential>
            <sequential>
                <echo level="info" message="Deleting backoffice jars"/>
                <delete quiet="true">
                    <fileset dir="${ext.backoffice.path}/web/webroot/WEB-INF/lib">
                        <include name="*_bof.jar"/>
                    </fileset>
                </delete>

                <echo level="info" message="Start copying rebel.xml configuration file"/>
                <copy todir="${ext.backoffice.path}/web/webroot/WEB-INF/classes">
                    <fileset dir="${ext.backoffice.path}/resources">
                        <include name="rebel.xml"/>
                    </fileset>
                </copy>
                <backoffice_remove_web_fragments/>
            </sequential>
        </sequential>
    </macrodef>

    <macrodef name="backoffice_after_build">
        <sequential>
            <backoffice_remove_web_fragments/>
            <backoffice_create_web_fragments/>
        </sequential>
    </macrodef>

    <target name="widgetsxsddoc">
        <callback extname="backoffice" target="widgetsxsddoc"/>
    </target>

    <macrodef name="backoffice_widgetsxsddoc">
        <sequential>
            <mkdir dir="${ext.backoffice.path}/resources/doc"/>
            <tempfile property="temp.dir" destDir="${java.io.tmpdir}" prefix="xslt"/>
            <mkdir dir="${temp.dir}"/>
            <echo message="Generating widgets.xsd documentation..."/>
            <get src="http://www.hybris.com/schema/cockpitng/widgets.xsd" dest="${temp.dir}/widgets.xsd" verbose="false"
                 usetimestamp="false"/>
            <xslt in="${temp.dir}/widgets.xsd" out="${ext.backoffice.path}/resources/doc/widgets-xsd.html"
                  style="${platformhome}/resources/xsl/xsd-doc.xsl" force="true"/>
            <delete dir="${temp.dir}"/>
        </sequential>
    </macrodef>

    <macrodef name="backoffice_remove_web_fragments">
        <sequential>
            <if>
                <available file="${backofficeLibDir}" type="dir" />
                <then>
                    <delete includeemptydirs="true">
                        <fileset dir="${backofficeLibDir}" includes="**/${backofficeFragmentPattern}*.jar"/>
                    </delete>
                </then>
            </if>
        </sequential>
    </macrodef>

    <macrodef name="backoffice_create_web_fragments">
        <sequential>
            <if>
                <available file="${webFragmentsSrcDir}"/>
                <then>
                    <for param="dirPath">
                        <path>
                            <dirset dir="${webFragmentsSrcDir}">
                                <include name="*"/>
                            </dirset>
                        </path>
                        <sequential>
                            <var name="dirName" unset="true"/>
                            <basename property="dirName" file="@{dirPath}"/>
                            <jar destfile="${backofficeLibDir}/${backofficeCoreFragmentPrefix}${dirName}.jar">
                                <metainf dir="@{dirPath}" includes="**/web-fragment.xml"/>
                            </jar>
                        </sequential>
                    </for>
                </then>
            </if>
        </sequential>
    </macrodef>

    <patternset id="backoffice.localization.pattern">
        <!-- core and hmc  -->
        <include name="**/*locales*_en.properties" />
        <exclude name="**/hmc/web/webroot/WEB-INF/classes/**/*" />
        <exclude name="**/unittest/**/*" />

        <!-- cockpit (ng) -->
        <include name="**/i3-label_en.properties"/>
        <include name="**/labels_en.properties" />

        <!-- messages -->
        <include name="**/*messages_en.properties" />
        <include name="**/*messages.properties" />

        <!-- frontend properties files in WEB-INF/messages folder -->
        <include name="**/WEB-INF/messages/*_en.properties" />

        <!-- csv and impex -->
        <include name="**/*_en.csv" />
        <include name="**/*_en.impex" />

        <include name="**/lang-en.properties" />

        <!-- email localizations from yacceleratorcore -->
        <include name="resources/**/messages/*_en.properties" />

        <!-- include validation messages -->
        <include name="resources/**/ValidationMessages.properties" />
    </patternset>

</project>


